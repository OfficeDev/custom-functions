<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=Edge" />
		<meta http-equiv="Expires" content="0" />
		<title>Custom Functions Upgrade Test</title>
		<script type="text/javascript">
			var g_mutationObserverReset = false;
			if (!window.Promise && window.MutationObserver)
			{
				console.log('Set MutationObserver to null to workaround Promise issue');
				window.MutationObserver = null;
				g_mutationObserverReset = true;
			}
		</script>
		<script src="https://unpkg.com/@microsoft/office-js@1.1.35-custom.2/dist/office.debug.js" type="text/javascript"></script>
		<script src="custom-functions.js" type="text/javascript"></script>
		<script type="text/javascript">
			var g_sharedAppData = {};
			var g_BgAppVisibilityState = {};

			function setSpanText(elementId, value) {
				var txt = document.createTextNode(value);
				var span = document.getElementById(elementId);
				if (span.hasChildNodes()) {
					span.removeChild(span.childNodes[0]);
				}
				span.appendChild(txt);
			}

			function appCmdUpdateSharedAppData(event) {
				g_sharedAppData.value = 2019;
				event.completed();
			}

			function BtnReadData() {
				setSpanText("SpanData", g_sharedAppData.value);
			}

			function BtnSetData() {
				var value = document.getElementById("TxtData").value;
				if (!value) {
					value = 2019;
				}

				g_sharedAppData.value = value;
			}

            function BtnShow() {
				SetRuntimeVisibleHelper(true);
			}
			
            function BtnHide() {
				SetRuntimeVisibleHelper(false);
            }
			
            function BtnGetRuntimeState() {
				// _getState() is the internal API and it's only for Microsoft engineer team internal testing purpose. Please do not use it.
				return Office.currentTaskpane._getState()
				.then(function (value) {
					setSpanText("SpanGetRuntimeState", value);
					return value;
				})
				.catch(function (error) {
					return error.code;
				});
            }


			function BtnSetStartupBehaviorLoad() {
				SetStartupBehaviorHelper(Office.StartupBehavior.load);
			}

			function BtnSetStartupBehaviorNone() {
				SetStartupBehaviorHelper(Office.StartupBehavior.none);
			}
			
			function BtnGetStartupBehavior() {
				return Office.currentTaskpane.getStartupBehavior()
				.then(function (value) {
					setSpanText("SpanGetStartupBehavior", value);
					return value;
				})
				.catch(function (error) {
					return error.code;
				});
            }

			// App Commands
			function appCmdSetStateVisible(event) {
				SetRuntimeVisibleHelper(true);
				event.completed();   
			}
			
			function appCmdSetStateBackground(event) {
				SetRuntimeVisibleHelper(false);
				event.completed();
			}

			function log(value) {
				var now = new Date();
				var time = '[' + now.getMinutes() + ':' + now.getSeconds() + '.' + now.getMilliseconds() + '] ';
				var txt = document.createTextNode(time + value);
				var div = document.createElement('div');
				div.appendChild(txt);
				document.getElementById('DivLog').appendChild(div);
			}
			
			// Event handler
			Office.onReady(function(info) {
				if (info.platform === Office.PlatformType.OfficeOnline) {
					log('onVisiblityChanged will be implementated soon');
				}
				else {
					log('Registering onVisiblityChanged');
					Office.currentTaskpane.onVisibilityChanged.add(function(args) {
						g_BgAppVisibilityState.value = args.visibility;
						setSpanText("SpanVisiblityEventResult", args.visibility);
						log('onVisiblityChanged:' + args.visibility);
					}).then(function(){
						log('Regisered onVisiblityChanged');
					}).catch(function(e){
						log('Failed to register onVisiblityChanged:' + JSON.stringify(e));
					});
				}
			});
		</script>
	</head>
	<body>
		<div>
			Data
			<div>
				<button id="BtnSetData" onclick="BtnSetData()">SetData</button>: <input id="TxtData" type="text" />
			</div>
			<div>
				<button id="BtnReadData" onclick="BtnReadData()">ReadData</button>: <span id="SpanData"></span>
			</div>
		</div>
		<div>
			Visibility
			<div>
				<button id="BtnSetRuntimeState" onclick="BtnShow()">Show</button>
				<button id="BtnSetRuntimeState" onclick="BtnHide()">Hide</button>
			</div>
			<div>
				<button id="BtnGetRuntimeState" onclick="BtnGetRuntimeState()">GetRuntimeState</button>: <span id="SpanGetRuntimeState"></span>
			</div>
			<div>
				Visiblity Event Result: <span id="SpanVisiblityEventResult"></span>
			</div>
		</div>
		<div>
			Startup Behavior
			<div>
				<button id="BtnSetStartupBehaviorLoad" onclick="BtnSetStartupBehaviorLoad()">SetStartupBehaviorLoad</button>
				<button id="BtnSetStartupBehaviorNone" onclick="BtnSetStartupBehaviorNone()">SetStartupBehaviorNone</button>
			</div>
			<div>
				<button id="BtnGetStartupBehavior" onclick="BtnGetStartupBehavior()">GetStartupBehavior</button>: <span id="SpanGetStartupBehavior"></span>
			</div>
		</div>
		<div>Logs:</div>
		<div id="DivLog">
		</div>
		<script type="text/javascript">
			log('MutationObserverReset=' + g_mutationObserverReset);
		</script>
	</body>
</html>
